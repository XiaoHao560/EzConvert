// gradle/versioning.gradle

ext {
    // 版本号生成相关方法
    getGitVersionCode = {
        try {
            def commitCount = getCmdOutput("git rev-list --count HEAD").toInteger()
            def timestamp = new java.text.SimpleDateFormat("yyMMdd").format(new Date()).toInteger()
            def versionCode = timestamp * 1000 + (commitCount % 1000)
            
            println "=== VersionCode Generation ==="
            println "Build Date: ${new Date()}"
            println "Git Commit Count: $commitCount"
            println "Timestamp (YYMMDD): $timestamp"
            println "Generated VersionCode: $versionCode"
            
            return versionCode
            
        } catch (Exception e) {
            println "Warning: Could not get git version code: ${e.message}"
            def fallback = new java.text.SimpleDateFormat("yyMMddHH").format(new Date()).toInteger()
            println "Using fallback version code: $fallback"
            return fallback
        }
    }

    getGitVersionName = {
        try {
            def describe = getCmdOutput("git describe --tags --long --always")
            def commitHash = getCmdOutput("git rev-parse --short HEAD")
            
            println "=== VersionName Generation ==="
            println "Git Describe: $describe"
            println "Commit Hash: $commitHash"
            
            def branchName = getCmdOutput("git rev-parse --abbrev-ref HEAD")
            def isDetachedHEAD = (branchName == "HEAD")
            
            if (isDetachedHEAD) {
                def githubRef = System.getenv("GITHUB_REF")
                println "GITHUB_REF: $githubRef"
                
                if (githubRef?.startsWith("refs/tags/")) {
                    println "Tag build detected, using tag-based versioning"
                    return extractVersionFromTag(describe)
                } else if (githubRef?.startsWith("refs/heads/")) {
                    branchName = githubRef.substring(11)
                    println "Recovered branch name from GITHUB_REF: $branchName"
                } else if (githubRef?.startsWith("refs/pull/")) {
                    def prNumber = githubRef.split("/")[2]
                    branchName = "pr-$prNumber"
                    println "PR build detected, using branch: $branchName"
                } else {
                    branchName = "detached-${commitHash}"
                }
            }
            
            def isMainBranch = isMainBranch(branchName)
            
            println "Final Branch: $branchName"
            println "Is Main Branch: $isMainBranch"
            
            if (describe.contains("0.1.7-alpha")) {
                return isMainBranch ? "0.2.0.alpha" : "0.2.0.alpha-${getSafeBranchName(branchName)}"
            }
            
            if (describe.matches("^v?\\d+(\\.\\d+)*\$")) {
                def version = describe.replaceAll("^v", "")
                return isMainBranch ? version : "${version}-${getSafeBranchName(branchName)}"
            }
            else if (describe.matches(".*-\\d+-g[0-9a-f]+\$")) {
                def parts = describe.split("-")
                def baseVersion = parts[0].replaceAll("^v", "")
                def commitsAfterTag = parts[1]
                
                if (commitsAfterTag == "0") {
                    return isMainBranch ? baseVersion : "${baseVersion}-${getSafeBranchName(branchName)}"
                }
                
                return isMainBranch ? "${baseVersion}.${commitsAfterTag}" : "${baseVersion}.${commitsAfterTag}-${getSafeBranchName(branchName)}"
            }
            else {
                return isMainBranch ? "0.2.0-${commitHash}" : "0.2.0-${getSafeBranchName(branchName)}"
            }
            
        } catch (Exception e) {
            println "Error getting git version name: ${e.message}"
            return "0.2.0-dev"
        }
    }

    extractVersionFromTag = { describe ->
        if (describe.matches("^v?\\d+(\\.\\d+)*\$")) {
            return describe.replaceAll("^v", "")
        }
        else if (describe.matches(".*-\\d+-g[0-9a-f]+\$")) {
            def parts = describe.split("-")
            def baseVersion = parts[0].replaceAll("^v", "")
            def commitsAfterTag = parts[1]
            
            if (commitsAfterTag == "0") {
                return baseVersion
            }
            
            return "${baseVersion}.${commitsAfterTag}"
        }
        else {
            return describe
        }
    }

    isMainBranch = { branchName ->
        return branchName == "main" || branchName == "master" || 
               branchName.startsWith("refs/tags/") ||
               branchName.startsWith("pr-")
    }

    getSafeBranchName = { branchName ->
        return branchName
            .replaceAll("[^a-zA-Z0-9.-]", "-")
            .replaceAll("^-+|-+\$", "")
            .replaceAll("-+", "-")
            .toLowerCase()
            .take(15)
    }

    getCmdOutput = { command ->
        def stdout = new ByteArrayOutputStream()
        try {
            exec {
                commandLine command.split(' ')
                standardOutput = stdout
            }
            return stdout.toString().trim()
        } catch (Exception e) {
            throw e
        }
    }
}

// 版本信息打印任务
task printVersionInfo {
    doLast {
        println "=== Project Version Information ==="
        println "Version Code: ${getGitVersionCode()}"
        println "Version Name: ${getGitVersionName()}"
        
        try {
            def branchName = getCmdOutput("git rev-parse --abbrev-ref HEAD")
            def commitHash = getCmdOutput("git rev-parse --short HEAD")
            def describe = getCmdOutput("git describe --tags --long --always")
            
            println "Git Branch: $branchName"
            println "Git Commit: $commitHash"
            println "Git Describe: $describe"
        } catch (Exception e) {
            println "Cannot get Git information: ${e.message}"
        }
    }
}