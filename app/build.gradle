plugins {
    id 'com.android.application'
}

def getGitVersionCode() {
    try {
        def commitCount = getCmdOutput("git rev-list --count HEAD").toInteger()
        def timestamp = new java.text.SimpleDateFormat("yyMMdd").format(new Date()).toInteger()
        def versionCode = timestamp * 1000 + (commitCount % 1000)
        
        println "=== VersionCode Generation ==="
        println "Build Date: ${new Date()}"
        println "Git Commit Count: $commitCount"
        println "Timestamp (YYMMDD): $timestamp"
        println "Generated VersionCode: $versionCode"
        
        return versionCode
        
    } catch (Exception e) {
        println "Warning: Could not get git version code: ${e.message}"
        def fallback = new java.text.SimpleDateFormat("yyMMddHH").format(new Date()).toInteger()
        println "Using fallback version code: $fallback"
        return fallback
    }
}

def getGitVersionName() {
    try {
        def describe = getCmdOutput("git describe --tags --long --always")
        def commitHash = getCmdOutput("git rev-parse --short HEAD")
        
        println "=== VersionName Generation ==="
        println "Git Describe: $describe"
        println "Commit Hash: $commitHash"
        
        def branchName = getCmdOutput("git rev-parse --abbrev-ref HEAD")
        def isDetachedHEAD = (branchName == "HEAD")
        
        if (isDetachedHEAD) {
            def githubRef = System.getenv("GITHUB_REF")
            println "GITHUB_REF: $githubRef"
            
            if (githubRef?.startsWith("refs/tags/")) {
                println "Tag build detected, using tag-based versioning"
                return extractVersionFromTag(describe)
            } else if (githubRef?.startsWith("refs/heads/")) {
                branchName = githubRef.substring(11)
                println "Recovered branch name from GITHUB_REF: $branchName"
            } else if (githubRef?.startsWith("refs/pull/")) {
                def prNumber = githubRef.split("/")[2]
                branchName = "pr-$prNumber"
                println "PR build detected, using branch: $branchName"
            } else {
                branchName = "detached-${commitHash}"
            }
        }
        
        def isMainBranch = isMainBranch(branchName)
        
        println "Final Branch: $branchName"
        println "Is Main Branch: $isMainBranch"
        
        if (describe.contains("0.1.7-alpha")) {
            return isMainBranch ? "0.2.0.alpha" : "0.2.0.alpha-${getSafeBranchName(branchName)}"
        }
        
        if (describe.matches("^v?\\d+(\\.\\d+)*\$")) {
            def version = describe.replaceAll("^v", "")
            return isMainBranch ? version : "${version}-${getSafeBranchName(branchName)}"
        }
        else if (describe.matches(".*-\\d+-g[0-9a-f]+\$")) {
            def parts = describe.split("-")
            def baseVersion = parts[0].replaceAll("^v", "")
            def commitsAfterTag = parts[1]
            
            if (commitsAfterTag == "0") {
                return isMainBranch ? baseVersion : "${baseVersion}-${getSafeBranchName(branchName)}"
            }
            
            return isMainBranch ? "${baseVersion}.${commitsAfterTag}" : "${baseVersion}.${commitsAfterTag}-${getSafeBranchName(branchName)}"
        }
        else {
            return isMainBranch ? "0.2.0-${commitHash}" : "0.2.0-${getSafeBranchName(branchName)}"
        }
        
    } catch (Exception e) {
        println "Error getting git version name: ${e.message}"
        return "0.2.0-dev"
    }
}

def extractVersionFromTag(describe) {
    if (describe.matches("^v?\\d+(\\.\\d+)*\$")) {
        return describe.replaceAll("^v", "")
    }
    else if (describe.matches(".*-\\d+-g[0-9a-f]+\$")) {
        def parts = describe.split("-")
        def baseVersion = parts[0].replaceAll("^v", "")
        def commitsAfterTag = parts[1]
        
        if (commitsAfterTag == "0") {
            return baseVersion
        }
        
        return "${baseVersion}.${commitsAfterTag}"
    }
    else {
        return describe
    }
}

def isMainBranch(branchName) {
    return branchName == "main" || branchName == "master" || 
           branchName.startsWith("refs/tags/") ||
           branchName.startsWith("pr-")
}

def getSafeBranchName(branchName) {
    return branchName
        .replaceAll("[^a-zA-Z0-9.-]", "-")
        .replaceAll("^-+|-+\$", "")
        .replaceAll("-+", "-")
        .toLowerCase()
        .take(15)
}

def getCmdOutput(command) {
    def stdout = new ByteArrayOutputStream()
    try {
        exec {
            commandLine command.split(' ')
            standardOutput = stdout
        }
        return stdout.toString().trim()
    } catch (Exception e) {
        throw e
    }
}

task printVersionInfo {
    doLast {
        println "=== Project Version Information ==="
        println "Version Code: ${getGitVersionCode()}"
        println "Version Name: ${getGitVersionName()}"
        
        try {
            def branchName = getCmdOutput("git rev-parse --abbrev-ref HEAD")
            def commitHash = getCmdOutput("git rev-parse --short HEAD")
            def describe = getCmdOutput("git describe --tags --long --always")
            
            println "Git Branch: $branchName"
            println "Git Commit: $commitHash"
            println "Git Describe: $describe"
        } catch (Exception e) {
            println "Cannot get Git information: ${e.message}"
        }
    }
}

android {
    namespace 'com.tech.ezconvert'
    compileSdk 33

    defaultConfig {
        applicationId "com.tech.ezconvert"
        minSdk 24
        targetSdk 33
        
        versionCode getGitVersionCode()
        versionName getGitVersionName()
        
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        vectorDrawables.useSupportLibrary = true
        
        externalNativeBuild {
            cmake {
                cppFlags "-std=c++17"
                arguments "-DANDROID_STL=c++_shared"
            }
        }
        
        ndk {
            abiFilters 'arm64-v8a'
        }
    }
    
    applicationVariants.all { variant ->
        variant.outputs.all {
            def appName = "EzConvert"
            def buildType = variant.buildType.name
            def versionName = variant.versionName
            def versionCode = variant.versionCode
            
            def suffix = buildType == "debug" ? "-debug" : ""
            
            outputFileName = "${appName}${suffix}-v${versionName}(${versionCode}).apk"
        }
    }
    
    signingConfigs {
        release {
            storeFile file(System.getenv("KEYSTORE_FILE") ?: "debug.keystore")
            storePassword System.getenv("KEYSTORE_PASSWORD")
            keyAlias System.getenv("KEY_ALIAS")
            keyPassword System.getenv("KEY_PASSWORD")
        }
    }
    
    buildTypes {
        release {
            signingConfig signingConfigs.release
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    
    externalNativeBuild {
        cmake {
            path file('src/main/cpp/CMakeLists.txt')
            version "3.22.1"
        }
    }
    
    ndkVersion "24.0.8215888"
    
    packagingOptions {
        pickFirst '**/libc++_shared.so'
    }
}

dependencies {
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.9.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.core:core-splashscreen:1.0.1'
    
    implementation 'com.arthenica:ffmpeg-kit-full-gpl:6.0-2'

    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
}

preBuild {
    doFirst {
        println "Build Info: ${getGitVersionName()} (${getGitVersionCode()})"
    }
}